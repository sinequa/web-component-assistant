<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AssistantElement</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap");
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        font-family: "Roboto", sans-serif;
      }
      body, #main-container {
        height: 100vh;
        width: 100vw;
      }
      #main-container {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;
      }
      #left-menu {
        width: 20vw;
        min-width: 200px;
        max-width: 400px;
        height: 100vh;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
      }
      #chat {
        width: 80vw;
        height: 100vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .menu-section {
        padding: 0.5rem 0.5rem 0 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .menu-section + .menu-section {
        margin-top: 0.5rem;
      }
      .h-100 {
        height: 100%;
      }
      .d-flex {
        display: flex;
      }
      .flex-column {
        flex-direction: column;
      }
      .gap-3 {
        gap: 1rem;
      }
      .list-unstyled {
        list-style-type: none;
      }
      .overflow-auto {
        overflow: auto;
      }
      .flex-grow-1 {
        flex-grow: 1;
      }
      .pe-2 {
        padding-right: 0.5rem;
      }
      .pb-2 {
        padding-bottom: 0.5rem;
      }
      .mt-auto {
        margin-top: auto;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .user-input .form-control {
        outline: none;
      }
    </style>
  </head>
  <body>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js"
      integrity="sha512-b+nQTCdtTBIRIbraqNEwsjB6UvL3UEMkXnhzd8awtCYh0Kcsjl9uEgwVFVbhoj3uu1DO1ZMacNvLoyJJiNfcvg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <div id="main-container">
      <div id="saved-chats"></div>
      <div id="chat"></div>
    </div>
    <script type="module">
      import {
        setGlobalConfig,
        getToken,
        setToken,
        post,
        login,
        logout,
        fetchQuery,
        globalConfig,
        fetchApp,
      } from "./atomic.js";

      setGlobalConfig({
        app: "<AppName>",
        // autoOAuthProvider: "",
      });

      // storing token in sessionStorage simulating storing from higher level app
      sessionStorage.setItem(
        "assistant-web-component-token",
        "<AuthToken>"
      );

      const assistantConfig = {
        instanceId: "standalone-assistant",
        additionalWorkflowProperties: { test: "you should see this" },
        query: { name: "<QueryWebServiceName>" },
      };

      logout();

      await login().then(() => {
        initSinequaAssistant();
      });

      async function initSinequaAssistant() {
        // get token from session storage
        const token = sessionStorage.getItem("assistant-web-component-token");
        // metadata for challenge request
        const { app, backendUrl } = globalConfig;
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
        const body = {
          action: "get",
          tokenInCookie: true,
        };

        try {
          // challenge request
          fetch(`${backendUrl}/api/v1/security.webtoken`, {
            method: "POST",
            headers,
            body: JSON.stringify(body),
          })
            .then((response) => response.json())
            // store token in usual place
            .then((data) => setToken(data.csrfToken))
            // instantiate components
            .then(() => {
              // Chat
              var chatElement = document.createElement("sq-chat-wrapper");
              chatElement.style = "display: block; width: 100%; height: 100%;";
              chatElement.appConfig = globalConfig;
              chatElement.instanceId = assistantConfig.instanceId;
              chatElement.additionalWorkflowProperties =
                assistantConfig.additionalWorkflowProperties;
              chatElement.query = assistantConfig.query;

              chatElement.addEventListener("openDocument", (event) =>
                console.log("Open document event", event)
              );
              chatElement.addEventListener("openPreview", (event) =>
                console.log("Open preview event", event)
              );

              // Saved Chats
              var savedChatsElement = document.createElement("sq-saved-chats-wrapper");
              savedChatsElement.style = "display: block; width: 100%; height: 100%;";
              savedChatsElement.instanceId = assistantConfig.instanceId;
              

              // Append to container
              document.getElementById("saved-chats").appendChild(savedChatsElement);
              document.getElementById("chat").appendChild(chatElement);
            });
        } catch (error) {
          console.error("Error making POST request:", error);
          throw error;
        }
      }
    </script>
  </body>
</html>
