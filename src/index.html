<!DOCTYPE html>
<html lang="en">
  <!-- Head section -->
  <head>
    <meta charset="utf-8" />
    <title>Assistant web components</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <!-- Body section -->
  <body>
    <!-- Main template  -->
    <div id="main-container">
      <div id="left-menu">
        <div id="settings-section" class="menu-section">
          <button class="btn btn-primary p-2 text-start" onclick="toggleSettings()">
            <i class="fas fa-cog"></i> Settings
          </button>
        </div>
        <div id="new-conversation-section" class="menu-section">
          <button class="btn btn-primary p-2 text-start" onclick="startNewDiscussion()">
            <i class="fas fa-plus"></i> New discussion
          </button>
        </div>
        <div id="document-overview-section" class="menu-section"></div>
        <div id="saved-chats-section" class="menu-section flex-grow-1"></div>
      </div>
      <div id="chat"></div>
      <div id="document-upload"></div>
    </div>
    <!-- Scripts -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js"
      integrity="sha512-b+nQTCdtTBIRIbraqNEwsjB6UvL3UEMkXnhzd8awtCYh0Kcsjl9uEgwVFVbhoj3uu1DO1ZMacNvLoyJJiNfcvg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer">
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous">
    </script>
    <script type="module">
      import {
        setGlobalConfig,
        getToken,
        setToken,
        post,
        login,
        logout,
        fetchQuery,
        globalConfig,
        fetchApp,
      } from "./atomic.js";

      setGlobalConfig({
        app: "<AppName>",
        // autoOAuthProvider: "",
      });

      // storing token in sessionStorage simulating storing from higher level app
      sessionStorage.setItem(
        "assistant-web-component-token",
        // !! insert token below
        "<AuthToken>"
      );

      const assistantConfig = {
        instanceId: "standalone-assistant",
        additionalWorkflowProperties: { test: "you should see this" },
        query: { name: "<QueryWebServiceName>" },
      };

      logout();

      await login().then(() => {
        initSinequaAssistant();
      });

      async function initDocumentsUpload() {
        const app = await fetchApp();
        if (!!app?.data?.documentsUploadSettings?.enabled) {
          // Document Overview Wrapper
          const documentOverviewElement = document.createElement("sq-document-overview-wrapper");
          documentOverviewElement.style = "display: block; width: 100%; height: 100%;";
          document.getElementById("document-overview-section").appendChild(documentOverviewElement);
          // Document Upload Wrapper
          const documentUploadElement = document.createElement("sq-document-upload-wrapper");
          document.getElementById("document-upload").appendChild(documentUploadElement);
        }
      }

      async function initSinequaAssistant() {
        // get token from session storage
        const token = sessionStorage.getItem("assistant-web-component-token");
        // metadata for challenge request
        const { app, backendUrl } = globalConfig;
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
        const body = {
          action: "get",
          tokenInCookie: true,
        };

        try {
          // challenge request
          fetch(`${backendUrl}/api/v1/security.webtoken`, {
            method: "POST",
            headers,
            body: JSON.stringify(body),
          })
            .then((response) => response.json())
            // store token in usual place
            .then((data) => setToken(data.csrfToken))
            // instantiate components
            .then(() => {
              // Chat Wrapper
              var chatElement = document.createElement("sq-chat-wrapper");
              chatElement.style = "display: block; width: 100%; height: 100%;";
              chatElement.appConfig = globalConfig;
              chatElement.instanceId = assistantConfig.instanceId;
              chatElement.additionalWorkflowProperties = assistantConfig.additionalWorkflowProperties;
              chatElement.query = assistantConfig.query;
              document.getElementById("chat").appendChild(chatElement);

              // Settings Wrapper
              var settingsWrapper = document.createElement("sq-chat-settings-wrapper");
              settingsWrapper.style = "display: none; width: 100%;";
              settingsWrapper.instanceId = assistantConfig.instanceId;
              document.getElementById("settings-section").appendChild(settingsWrapper);

              // Toggle settings display
              window.toggleSettings = function () {
                settingsWrapper.style.display = settingsWrapper.style.display === "none" ? "block" : "none";
              }

              // New Discussion Button
              window.startNewDiscussion = function () {
                document.dispatchEvent(new CustomEvent("newDiscussion"));
              }

              // Saved Chats Wrapper
              var savedChatsElement = document.createElement("sq-saved-chats-wrapper");
              savedChatsElement.style = "display: block; width: 100%; height: 100%;";
              savedChatsElement.instanceId = assistantConfig.instanceId;
              document.getElementById("saved-chats-section").appendChild(savedChatsElement);

              // Document upload elements if enabled
              initDocumentsUpload();

            });
        } catch (error) {
          console.error("Error making POST request:", error);
          throw error;
        }
      }
    </script>
  </body>
</html>
